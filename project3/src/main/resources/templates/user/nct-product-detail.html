<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${nctProduct.nctProductName}">Product Detail</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/nct-user-style.css}">
</head>

<body>
<div th:replace="~{fragments/nct-header :: header}"></div>

<div th:replace="~{fragments/nct-sidebar :: sidebar(activePage='products')}"></div>

<main class="main-content">
    <div class="product-detail-wrapper">
        <!-- Product Images -->
        <div class="product-images">
            <div class="thumbnail-list">
                <div class="thumbnail-item active" onclick="changeMainImage(this)">
                    <img th:src="${nctProduct.nctImageUrl}" th:alt="${nctProduct.nctProductName}">
                </div>
            </div>
            <div class="main-image">
                <img id="mainImage" th:src="${nctProduct.nctImageUrl}" th:alt="${nctProduct.nctProductName}">
            </div>
        </div>

        <!-- Product Info -->
        <div class="product-info">
            <h1 th:text="${nctProduct.nctProductName}">Product Name</h1>
            <div class="product-status" hidden>
                Tình trạng: <span th:text="${nctProduct.nctStatus}">Status</span>
            </div>
            <div class="product-price" th:text="|₫ ${#numbers.formatDecimal(nctProduct.nctPrice, 0, 'COMMA', 0, 'POINT')}|">₫ 0</div>
            <div th:if="${nctProduct.nctOriginalPrice != null and nctProduct.nctOriginalPrice > nctProduct.nctPrice}"
                 class="product-original-price"
                 th:text="|₫ ${#numbers.formatDecimal(nctProduct.nctOriginalPrice, 0, 'COMMA', 0, 'POINT')}|">₫ 0</div>

            <div class="payment-options">
                <h6>Thanh toán</h6>
                <button class="payment-btn">Tiền Mặt</button>
                <button class="payment-btn">Chuyển Khoản</button>
            </div>

            <div class="action-buttons">
                <form id="product-action-form" method="post">
                    <input type="hidden" name="productId" th:value="${nctProduct.nctProductId}" />
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                    <!-- Quantity -->
                    <div class="flex items-center mb-4">
                        <label for="quantity" class="mr-4 font-semibold text-gray-700">Số lượng:</label>
                        <div class="flex items-center border rounded">
                            <button type="button" onclick="this.nextElementSibling.stepDown()" class="px-3 py-1 text-gray-600 hover:bg-gray-100">-</button>
                            <input type="number" id="quantity" name="quantity" value="1" min="1" th:max="${nctProduct.nctStockQuantity}" class="w-16 text-center border-l border-r focus:outline-none">
                            <button type="button" onclick="this.previousElementSibling.stepUp()" class="px-3 py-1 text-gray-600 hover:bg-gray-100">+</button>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex gap-4">
                        <!-- Add to Cart Button -->
                        <button type="submit"
                                id="addToCartBtn"
                                formaction="/cart/add"
                                class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-6 rounded-lg transition-colors">
                            <i class="fas fa-cart-plus mr-2"></i>Thêm vào giỏ
                        </button>

                        <!-- Buy Now Button -->
                        <button type="submit"
                                formmethod="get"
                                formaction="/checkout/buy-now"
                                class="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                            <i class="fas fa-shopping-bag mr-2"></i>Mua ngay
                        </button>
                    </div>
                </form>
            </div>

            <div class="commitments">
                <h6>UMACT.vn cam kết bán hàng</h6>
                <ul>
                    <li><i class="fas fa-shipping-fast"></i>Miễn phí giao hàng toàn quốc</li>
                    <li><i class="fas fa-shield-alt"></i>Sản phẩm mới nguyên seal 100%</li>
                    <li><i class="fas fa-check-circle"></i>Hàng chính hãng 100%</li>
                </ul>
            </div>
        </div>
    </div>

    <div th:if="${nctRelatedProducts != null and !nctRelatedProducts.isEmpty()}" class="related-products">
        <h3>Sản phẩm liên quan</h3>
        <div class="product-grid">
            <div th:each="product : ${nctRelatedProducts}" class="product-card">
                <a th:href="@{/products/{id}(id=${product.nctProductId})}" style="text-decoration: none; color: inherit;">
                    <div class="product-image">
                        <img th:src="${product.nctImageUrl}"
                             th:alt="${product.nctProductName}"
                             onerror="this.src='https://via.placeholder.com/200x200/f0f0f0/999?text=No+Image'">
                    </div>
                    <div class="product-info-card">
                        <div class="product-name" th:text="${product.nctProductName}"></div>
                        <div class="product-price-card" th:text="|₫ ${#numbers.formatDecimal(product.nctPrice, 0, 'COMMA', 0, 'POINT')}|"></div>
                    </div>
                </a>
            </div>
        </div>
    </div>
</main>

<div id="toast-container"></div>

<script>
    function changeMainImage(element) {
        const mainImage = document.getElementById('mainImage');
        const src = element.querySelector('img').src;
        mainImage.src = src;

        document.querySelectorAll('.thumbnail-item').forEach(item => {
            item.classList.remove('active');
        });
        element.classList.add('active');
    }

    function showToast(message, type = 'success') {
        const toastContainer = document.getElementById('toast-container');
        if (!toastContainer) return;

        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;

        toastContainer.appendChild(toast);

        // Trigger animation
        setTimeout(() => {
            toast.classList.add('show');
        }, 10);

        // Hide and remove after 3 seconds
        setTimeout(() => {
            toast.classList.remove('show');
            toast.addEventListener('transitionend', () => toast.remove());
        }, 3000);
    }

    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('product-action-form');
        const addToCartBtn = document.getElementById('addToCartBtn');

        if (form && addToCartBtn) {
            form.addEventListener('submit', function(event) {
                if (event.submitter === addToCartBtn) {
                    event.preventDefault(); // Prevent normal form submission

                    const formData = new FormData(form);
                    const url = addToCartBtn.getAttribute('formaction');

                    fetch(url, {
                        method: 'POST',
                        body: new URLSearchParams(formData)
                    })
                    .then(response => {
                        // Check if the response is ok, if not, parse the error json
                        if (!response.ok) {
                            return response.json().then(err => { throw err; });
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            showToast(data.message || 'Thêm vào giỏ hàng thành công!');
                            // You might want to update a cart count in your header here
                            // For example:
                            // const cartCountEl = document.getElementById('cart-item-count');
                            // if (cartCountEl && data.cartCount !== undefined) {
                            //     cartCountEl.textContent = data.cartCount;
                            // }
                        } else {
                            // This case might not be reached if using the !response.ok check above, but good for safety
                            showToast(data.message || 'Có lỗi xảy ra khi thêm vào giỏ.', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Fetch Error:', error);
                        // Display error message from server if available
                        const message = error.message || 'Không thể kết nối đến máy chủ.';
                        showToast(message, 'error');
                    });
                }
            });
        }
    });
</script>
</body>

</html>
